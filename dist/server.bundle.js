(()=>{"use strict";var e={334:e=>{e.exports=require("dotenv")}},t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("express");var t=n.n(e);const o=require("http");var r=n.n(o);const i=require("body-parser");var c=n.n(i);const s=require("passport");var a=n.n(s);const u=require("passport-google-oauth");n(334).config();var d=(0,e.Router)(),p="https://www.googleapis.com/auth/userinfo";d.route("/").get(a().authenticate("google",{scope:["".concat(p,".profile"),"".concat(p,".email")]})),d.route("/callback").get(a().authenticate("google",{failureRedirect:"/login"}),(function(e,t){return t.redirect("/")}));const l=d,f=require("@babel/runtime/helpers/defineProperty");var g=n.n(f);const m=require("mongoose");var v=n.n(m);const y=require("socket.io");var b,j={};var h=v().Schema,O=new h({_id:h.Types.ObjectId,title:String,creator:{type:h.Types.ObjectId,ref:"User"},members:[{type:h.Types.ObjectId,ref:"User"}],tasks:[{type:h.Types.ObjectId,ref:"Task"}]});const _=v().model("Project",O);var w=v().Schema,I=new w({username:String,email:String,userid:String,image:String,newnotifcount:Number,contacts:[{type:w.Types.ObjectId,ref:"User"}],projects:[{type:w.Types.ObjectId,ref:"Project"}],notifications:[{type:w.Types.ObjectId,ref:"Notification"}],sentMessages:[{type:w.Types.ObjectId,ref:"IndivMsg"}],receivedMessages:[{type:w.Types.ObjectId,ref:"IndivMsg"}]});const S=v().model("User",I),T=new function(){this.addContacts=function(e){S.updateMany({_id:e},{$addToSet:{contacts:{$each:e}}},(function(e,t){console.log(t)}))},this.updateNotificationCount=function(e){S.updateMany({_id:e},{$inc:{newnotifcount:1}},(function(e,t){console.log(t)}))},this.subscribe=function(e,t){_.find({_id:e},(function(e,n){t.join(n.name)}))}};var P=v().Schema,M=new P({project:{type:P.Types.ObjectId,ref:"Project"},task:{type:P.Types.ObjectId,ref:"Task"},to:{type:P.Types.ObjectId,ref:"User"},content:String},{timestamps:!0});const N=v().model("Notification",M);function x(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function U(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?x(Object(n),!0).forEach((function(t){g()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):x(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const E=new function(){var e=this;this.createProject=function(t,n){var o=t.members.split(",");o.push(t.creator.email);var r=[],i=[];S.find({email:{$in:o}}).exec((function(o,c){c&&c.forEach((function(e){i.push({email:e.email,name:e.username,id:e._id,image:e.image}),r.push(e._id)}));var s=new _({_id:new(v().mongo.ObjectId),title:t.title,creator:t.creator._id,members:r});s.save((function(o){if(!o){S.updateMany({_id:{$in:r}},{$push:{projects:s._id}},(function(e,t){console.log(t)})),T.updateNotificationCount(r),T.addContacts(r),r.forEach((function(e){console.log(e),j[e]&&(console.log("online:",j[e].id),j[e].join(s._id))}));var c=U(U({},s._doc),{},{creator:{username:t.creator.username}});e.sendNotification({type:"newproject",members:r,projId:s._id,content:"You've been added to ".concat(t.title," project by ").concat(t.creator.username),projMembers:i,newProject:c,createdAt:new Date}),n.send("New project added")}}))}))},this.sendNotification=function(e){var t=new N({_id:new(v().mongo.ObjectId),project:e.projId,content:e.content});t.save((function(n){n||("newproject"===e.type&&S.updateMany({_id:{$in:e.members}},{$push:{notifications:t._id}},(function(e,t){console.log(t)})),b.to(e.projId).emit("notification",e))}))}};var q=(0,e.Router)();q.route("/").post((function(e,t){var n={title:e.body.title,members:e.body.members,creator:e.user};E.createProject(n,t)}));const k=q,C=function(e,t,n,o){n?t.sendFile(__dirname+"/dist_index.html"):o.outputFileSystem.readFile(o.outputPath+"/dist_index.html",(function(e,n){t.set("content-type","text/html"),t.send(n)}))};var R=(0,e.Router)();R.route("/").get((function(e,t){var n=e.user._id;S.findById(n).populate({path:"projects",populate:{path:"creator",select:"username"}}).populate("notifications").populate("contacts","username email _id image").exec((function(e,n){return t.send(n)}))})),R.route("/readnotifs").get((function(e,t){var n=e.user._id;console.log("read"),S.updateOne({_id:n},{newnotifcount:0},(function(){return t.send("Notifications read")}))}));const D=R;var $=function(e,t,n){e.isAuthenticated()?n():t.redirect("/login")};n(334).config();var A=process.env.ATLAS_URI;const z=require("express-session");var L=n.n(z);n(334).config();n(334).config();var B=t()(),F=r().createServer(B),Y=process.env.PORT||3e3;B.use(c().json()),function(e){e.use(L()({secret:process.env.SESSION_SECRET,resave:!1,saveUninitialized:!0})),e.use(a().initialize()),e.use(a().session()),a().use(new u.OAuth2Strategy({clientID:process.env.CLIENT_ID,clientSecret:process.env.CLIENT_SECRET,callbackURL:"http://localhost:3000/auth/google/callback"},(function(e,t,n,o){S.findOne({userid:n.id},(function(e,t){if(t)o(e,t);else{var r=new S({username:n.displayName,email:n.emails[0].value,userid:n.id,image:n.photos[0].value,newnotifcount:0});r.save(),o(e,r)}}))}))),a().serializeUser((function(e,t){t(null,e.id)})),a().deserializeUser((function(e,t){S.findById(e,(function(e,n){t(e,n)}))}))}(B),function(){v().connect(A,{useNewUrlParser:!0,useCreateIndex:!0,useUnifiedTopology:!0});var e=v().connection;e.on("error",console.error.bind(console,"connection error:")),e.once("open",(function(){console.log("MongoDB connected")}))}(),function(e){(b=y(e)).on("connection",(function(e){console.log("User connected",e.id),e.on("userinfo",(function(t){j[t]=e,console.log(t,j[t].id)})),e.on("disconnect",(function(){for(var t in j)j[t].id===e.id&&delete j[t];console.log("user disconnected")}))}))}(F),B.use(t().static(__dirname)),function(e,t){e.use("/auth/google",l),e.use("/login",(function(e,n){e.isAuthenticated()?n.redirect("/"):C(0,n,t.prodMode,t.compiler)})),e.use("/logout",(function(e,t){e.logout(),t.redirect("/login")})),e.all("*",$),e.use("/project",k),e.use("/user",D),e.use((function(e,n){return C(0,n,t.prodMode,t.compiler)}))}(B,{prodMode:!0,compiler:null}),F.listen(Y,(function(){console.log("server live @ ".concat(Y)),console.log("production")}))})()})();